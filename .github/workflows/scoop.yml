name: Scoop Distribution

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.2.0)"
        required: true
        type: string

jobs:
  scoop:
    name: Update Scoop Bucket
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    # Skip prereleases
    if: ${{ !github.event.release.prerelease || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Get release info
        id: release
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release: $TAG (v$VERSION)"

      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Get checksum from release
        id: checksum
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          curl -L -o SHA256SUMS.txt "https://github.com/AmarBego/GitTop/releases/download/v${VERSION}/SHA256SUMS.txt"

          CHECKSUM=$(grep "gittop-${VERSION}-windows-x86_64\.zip$" SHA256SUMS.txt | cut -d' ' -f1)

          if [ -z "$CHECKSUM" ]; then
            echo "::error::Could not find checksum for gittop-windows-x86_64.zip in SHA256SUMS.txt"
            exit 1
          fi

          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "Checksum: $CHECKSUM"

      - name: Update Scoop manifest
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          CHECKSUM="${{ steps.checksum.outputs.checksum }}"

          jq --arg ver "$VERSION" --arg hash "$CHECKSUM" '
            .version = $ver |
            .architecture."64bit".url = "https://github.com/AmarBego/GitTop/releases/download/v\($ver)/gittop-\($ver)-windows-x86_64.zip" |
            .architecture."64bit".hash = $hash
          ' bucket/gittop.json > bucket/gittop.json.tmp && mv bucket/gittop.json.tmp bucket/gittop.json

          echo "Updated bucket/gittop.json:"
          cat bucket/gittop.json

      - name: Create PR for Scoop update
        env:
          GH_TOKEN: ${{ secrets.SCOOP_PR_TOKEN }}
        run: |
          BRANCH="scoop-update-${{ steps.release.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add bucket/gittop.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git checkout -b "$BRANCH"
          git commit -m "scoop: update to ${{ steps.release.outputs.tag }}"
          git push origin "$BRANCH"

          gh pr create \
            --title "scoop: update to ${{ steps.release.outputs.tag }}" \
            --body "Automated Scoop manifest update for release ${{ steps.release.outputs.tag }}" \
            --base main \
            --head "$BRANCH"

      - uses: kesin11/actions-timeline@v2
