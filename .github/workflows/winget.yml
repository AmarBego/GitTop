name: Winget Distribution

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.2.0)"
        required: true
        type: string

jobs:
  winget:
    name: Update Winget Package
    runs-on: windows-latest
    permissions:
      contents: read
    # Skip prereleases
    if: ${{ !github.event.release.prerelease || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Get release info
        id: release
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ inputs.tag }}"
          } else {
            $tag = "${{ github.event.release.tag_name }}"
          }
          $version = $tag -replace '^v', ''
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Release: $tag (v$version)"

      - name: Install wingetcreate
        run: |
          Invoke-WebRequest https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Update Winget package
        run: |
          .\wingetcreate.exe update AmarBego.GitTop `
            --urls "https://github.com/AmarBego/GitTop/releases/download/${{ steps.release.outputs.tag }}/gittop-${{ steps.release.outputs.version }}-windows-x86_64-setup.exe|x64" `
            --version ${{ steps.release.outputs.version }} `
            --submit `
            --token ${{ secrets.WINGET_TOKEN }}

      - name: Overwrite PR Message
        env:
          GH_TOKEN: ${{ secrets.WINGET_TOKEN }}
        run: |
          Start-Sleep -Seconds 10
          $pr = gh pr list --repo microsoft/winget-pkgs --search "AmarBego.GitTop in:title is:pr is:open author:@me" --limit 1 --json number --jq '.[0].number'
          if ($pr) {
            gh pr edit $pr --repo microsoft/winget-pkgs --body "Automatically updated by workflow [GitTop Release ${{ steps.release.outputs.version }}]"
          }

      - uses: kesin11/actions-timeline@v2
