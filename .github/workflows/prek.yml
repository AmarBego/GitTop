name: Prek

on:
  workflow_run:
    workflows: ["Pull Request Labeler"]
    types:
      - completed

jobs:
  check-labels:
    name: Check Triage Status
    if: github.event.workflow_run.event == 'pull_request_target' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      head_sha: ${{ steps.check.outputs.head_sha }}
    steps:
      - name: Get PR info and check labels
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Get the PR that triggered the workflow
            const headSha = context.payload.workflow_run.head_sha;
            const headBranch = context.payload.workflow_run.head_branch;
            const headRepo = context.payload.workflow_run.head_repository.full_name;

            // Find the PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              head: `${headRepo.split('/')[0]}:${headBranch}`
            });

            const pr = prs.find(p => p.head.sha === headSha);
            if (!pr) {
              console.log("No matching PR found");
              core.setOutput("should_run", "false");
              return;
            }

            core.setOutput("pr_number", pr.number);
            core.setOutput("head_sha", headSha);

            const labels = pr.labels.map(l => l.name);
            const blockingLabels = ["triage/incomplete"];
            const hasBlocking = labels.some(l => blockingLabels.includes(l));

            if (hasBlocking) {
              console.log(`Blocking labels found: ${labels.filter(l => blockingLabels.includes(l)).join(", ")}`);
              core.setOutput("should_run", "false");
            } else {
              console.log("No blocking labels, proceeding with prek");
              core.setOutput("should_run", "true");
            }

  prek:
    name: Prek Checks
    needs: check-labels
    if: needs.check-labels.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-labels.outputs.head_sha }}

      - uses: taiki-e/install-action@v2
        with:
          tool: prek

      - name: Run prek
        id: run_prek
        shell: bash
        continue-on-error: true
        run: |
          set -o pipefail
          prek run --all-files 2>&1 | tee prek.log

      - name: Parse prek output
        id: prek_summary
        if: always()
        shell: bash
        run: |
          python3 - <<'PY'
          import os
          import re
          import json
          from pathlib import Path

          log_path = Path("prek.log")
          failed = []
          passed = []
          pattern = re.compile(r"^(?P<name>.+?)\.{3,}(?P<status>Passed|Failed)\s*$")

          if log_path.exists():
              for line in log_path.read_text(errors="ignore").splitlines():
                  match = pattern.match(line.strip())
                  if not match:
                      continue
                  name = match.group("name").strip()
                  status = match.group("status")
                  if status == "Failed":
                      failed.append(name)
                  else:
                      passed.append(name)

          # Write to GITHUB_OUTPUT
          output_path = os.environ.get("GITHUB_OUTPUT")
          if output_path:
              with open(output_path, "a", encoding="utf-8") as output:
                  output.write(f"failed_steps={','.join(failed)}\n")
                  output.write(f"passed_steps={','.join(passed)}\n")
                  output.write(f"total_steps={len(failed) + len(passed)}\n")

          # Write result to artifact file
          result = {
              "pr_number": int(os.environ.get("PR_NUMBER", 0)),
              "failed": len(failed) > 0,
              "failed_steps": failed,
              "passed_steps": passed
          }
          Path("prek-result.json").write_text(json.dumps(result))
          PY
        env:
          PR_NUMBER: ${{ needs.check-labels.outputs.pr_number }}

      - name: Upload prek result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prek-result
          path: prek-result.json
          retention-days: 1

      - name: Fail job if prek failed
        if: steps.run_prek.outcome == 'failure'
        run: exit 1
