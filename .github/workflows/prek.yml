name: Prek

on:
  workflow_run:
    workflows: ["Pull Request Labeler"]
    types:
      - completed

jobs:
  check-labels:
    name: Check Triage Status
    if: github.event.workflow_run.event == 'pull_request_target' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      head_sha: ${{ steps.check.outputs.head_sha }}
    steps:
      - name: Get PR info and check labels
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Get the PR that triggered the workflow
            const headSha = context.payload.workflow_run.head_sha;
            const headBranch = context.payload.workflow_run.head_branch;
            const headRepo = context.payload.workflow_run.head_repository.full_name;

            // Find the PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              head: `${headRepo.split('/')[0]}:${headBranch}`
            });

            const pr = prs.find(p => p.head.sha === headSha);
            if (!pr) {
              console.log("No matching PR found");
              core.setOutput("should_run", "false");
              return;
            }

            core.setOutput("pr_number", pr.number);
            core.setOutput("head_sha", headSha);

            const labels = pr.labels.map(l => l.name);
            const blockingLabels = ["triage/incomplete"];
            const hasBlocking = labels.some(l => blockingLabels.includes(l));

            if (hasBlocking) {
              console.log(`Blocking labels found: ${labels.filter(l => blockingLabels.includes(l)).join(", ")}`);
              core.setOutput("should_run", "false");
            } else {
              console.log("No blocking labels, proceeding with prek");
              core.setOutput("should_run", "true");
            }

  prek:
    name: Prek Checks
    needs: check-labels
    if: needs.check-labels.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-labels.outputs.head_sha }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libglib2.0-dev libgtk-3-dev libssl-dev

      - uses: j178/prek-action@v1
        id: prek
        continue-on-error: true
        with:
          install-only: false
          extra-args: "--all-files"

      - name: Create result artifact
        shell: bash
        run: |
          # Capture failed hooks from prek output
          # prek outputs "Failed" next to failing hook names
          FAILED_HOOKS=""
          PREK_OUTPUT=""

          if [ "${{ steps.prek.outcome }}" == "failure" ]; then
            # Get the prek output from the step
            PREK_OUTPUT=$(cat <<'PREK_OUTPUT_EOF'
          ${{ steps.prek.outputs.output || '' }}
          PREK_OUTPUT_EOF
            )
            
            # Try to extract failed hook names from common patterns
            # prek typically shows hook name followed by failure status
            if [ -n "$PREK_OUTPUT" ]; then
              FAILED_HOOKS=$(echo "$PREK_OUTPUT" | grep -E "(Failed|failed|FAILED)" | head -10 || true)
            fi
          fi

          # Escape for JSON
          PREK_OUTPUT_ESCAPED=$(echo "$PREK_OUTPUT" | head -100 | jq -Rs . | sed 's/^"//;s/"$//')
          FAILED_HOOKS_ESCAPED=$(echo "$FAILED_HOOKS" | jq -Rs . | sed 's/^"//;s/"$//')

          cat > prek-result.json << EOF
          {
            "pr_number": ${{ needs.check-labels.outputs.pr_number }},
            "failed": ${{ steps.prek.outcome == 'failure' }},
            "failed_steps": [],
            "output": "$PREK_OUTPUT_ESCAPED",
            "failed_summary": "$FAILED_HOOKS_ESCAPED"
          }
          EOF

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: prek-result
          path: prek-result.json
          retention-days: 1

      - name: Fail if prek failed
        if: steps.prek.outcome == 'failure'
        run: exit 1
