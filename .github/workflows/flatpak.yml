name: Flatpak Distribution

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  workflow_dispatch:

jobs:
  flatpak:
    name: Build Flatpak Bundle
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Download release metadata
        uses: actions/download-artifact@v4
        with:
          name: release-meta
          path: release-meta
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Read release info
        id: release
        run: |
          TAG=$(cat release-meta/tag)
          IS_PRERELEASE=$(cat release-meta/is_prerelease)
          VERSION="${TAG#v}"
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Release: $TAG (v$VERSION), Prerelease: $IS_PRERELEASE"

      - name: Skip prerelease
        if: steps.release.outputs.is_prerelease == 'true'
        run: |
          echo "::notice::Skipping Flatpak build for prerelease: ${{ steps.release.outputs.tag }}"

      - uses: actions/checkout@v4
        if: steps.release.outputs.is_prerelease != 'true'
        with:
          ref: ${{ steps.release.outputs.tag }}
      
      - name: Install Flatpak and dependencies
        if: steps.release.outputs.is_prerelease != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder appstream
          
          # Add Flathub remote
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          
          # Install Freedesktop SDK
          flatpak install -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08

      - name: Download Linux tarball
        if: steps.release.outputs.is_prerelease != 'true'
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          URL="https://github.com/AmarBego/GitTop/releases/download/v${VERSION}/gittop-linux-x86_64.tar.gz"
          
          curl -L -o gittop-linux-x86_64.tar.gz "$URL"
          tar -xzf gittop-linux-x86_64.tar.gz
          
          echo "Downloaded and extracted Linux tarball for v${VERSION}"
          ls -la gittop-linux-x86_64/
      
      - name: Prepare Flatpak manifest
        if: steps.release.outputs.is_prerelease != 'true'
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          
          # Create a simple manifest that uses the pre-built binary
          cat > packaging/flatpak/com.github.AmarBego.GitTop.yml << 'EOF'
          app-id: com.github.AmarBego.GitTop
          runtime: org.freedesktop.Platform
          runtime-version: '24.08'
          sdk: org.freedesktop.Sdk
          command: gittop
          
          finish-args:
            - --share=network
            - --socket=wayland
            - --socket=fallback-x11
            - --share=ipc
            - --talk-name=org.kde.StatusNotifierWatcher
            - --talk-name=org.freedesktop.Notifications
            - --own-name=org.kde.StatusNotifierItem-*
            - --talk-name=org.freedesktop.secrets
            - --device=dri
            - --filesystem=xdg-config/gittop:create
            - --filesystem=xdg-cache/gittop:create
            - --filesystem=xdg-data/gittop:create
          
          modules:
            - name: gittop
              buildsystem: simple
              build-commands:
                - install -Dm755 gittop /app/bin/gittop
                - install -Dm644 gittop.desktop /app/share/applications/com.github.AmarBego.GitTop.desktop
                - install -Dm644 gittop.png /app/share/icons/hicolor/256x256/apps/com.github.AmarBego.GitTop.png
                - install -Dm644 com.github.AmarBego.GitTop.metainfo.xml /app/share/metainfo/com.github.AmarBego.GitTop.metainfo.xml
              sources:
                - type: dir
                  path: ../../gittop-linux-x86_64
                - type: file
                  path: com.github.AmarBego.GitTop.metainfo.xml
          EOF
          
          echo "Created Flatpak manifest for version $VERSION"
      
      - name: Build Flatpak
        if: steps.release.outputs.is_prerelease != 'true'
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          
          # Build the Flatpak
          flatpak-builder --force-clean --repo=repo build-dir packaging/flatpak/com.github.AmarBego.GitTop.yml
          
          # Create bundle
          flatpak build-bundle repo gittop-${VERSION}.flatpak com.github.AmarBego.GitTop
          
          echo "Built Flatpak bundle: gittop-${VERSION}.flatpak"
          ls -lh gittop-${VERSION}.flatpak
      
      - name: Validate Flatpak
        if: steps.release.outputs.is_prerelease != 'true'
        run: |
          # Validate MetaInfo
          appstreamcli validate packaging/flatpak/com.github.AmarBego.GitTop.metainfo.xml || true
          
          # Test installation
          flatpak install -y --user gittop-${{ steps.release.outputs.version }}.flatpak
          
          echo "Flatpak validation complete"
      
      - name: Upload Flatpak to Release
        if: steps.release.outputs.is_prerelease != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          
          gh release upload ${{ steps.release.outputs.tag }} \
            gittop-${VERSION}.flatpak \
            --clobber \
            --repo AmarBego/GitTop
      
      - name: Upload artifact
        if: steps.release.outputs.is_prerelease != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle
          path: gittop-${{ steps.release.outputs.version }}.flatpak
