name: Chocolatey Distribution

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  workflow_dispatch:
      
jobs:
  check:
    name: Check Release Status
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      tag: ${{ steps.release.outputs.tag }}
      version: ${{ steps.release.outputs.version }}
    
    steps:
      - name: Download release metadata
        uses: actions/download-artifact@v4
        with:
          name: release-meta
          path: release-meta
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Read release info
        id: release
        run: |
          TAG=$(cat release-meta/tag)
          IS_PRERELEASE=$(cat release-meta/is_prerelease)
          VERSION="${TAG#v}"
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Release: $TAG (v$VERSION), Prerelease: $IS_PRERELEASE"

      - name: Determine if should run
        id: check
        run: |
          if [ "${{ steps.release.outputs.is_prerelease }}" == "true" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "::notice::Skipping Chocolatey publish for prerelease: ${{ steps.release.outputs.tag }}"
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  chocolatey:
    name: Publish to Chocolatey
    needs: check
    runs-on: windows-latest
    permissions:
      actions: read
      contents: read
    if: ${{ needs.check.outputs.should_build == 'true' }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.check.outputs.tag }}

      - name: Download EXE installer
        shell: pwsh
        run: |
          $version = "${{ needs.check.outputs.version }}"
          $url = "https://github.com/AmarBego/GitTop/releases/download/v$version/gittop-$version-setup.exe"
          Invoke-WebRequest -Uri $url -OutFile gittop-setup.exe
          
          # Calculate checksum
          $hash = (Get-FileHash gittop-setup.exe -Algorithm SHA256).Hash
          echo "checksum=$hash" >> $env:GITHUB_OUTPUT
        id: download

      - name: Prepare Chocolatey package
        shell: pwsh
        run: |
          $version = "${{ needs.check.outputs.version }}"
          $checksum = "${{ steps.download.outputs.checksum }}"
          
          # Update nuspec
          $nuspec = Get-Content packaging/chocolatey/gittop.nuspec -Raw
          $nuspec = $nuspec -replace '\{\{VERSION\}\}', $version
          Set-Content packaging/chocolatey/gittop.nuspec $nuspec
          
          # Update install script
          $install = Get-Content packaging/chocolatey/tools/chocolateyInstall.ps1 -Raw
          $install = $install -replace '\{\{VERSION\}\}', $version
          $install = $install -replace '\{\{CHECKSUM\}\}', $checksum
          Set-Content packaging/chocolatey/tools/chocolateyInstall.ps1 $install
          
          Write-Host "Updated package for version $version with checksum $checksum"

      - name: Pack Chocolatey package
        shell: pwsh
        run: |
          cd packaging/chocolatey
          choco pack
          Get-ChildItem *.nupkg

      - name: Push to Chocolatey
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          cd packaging/chocolatey
          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          choco push $nupkg.Name --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY
