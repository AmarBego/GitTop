name: Chocolatey Distribution

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.2.0)"
        required: true
        type: string

jobs:
  chocolatey:
    name: Publish to Chocolatey
    runs-on: windows-latest
    permissions:
      contents: read
    # Skip prereleases
    if: ${{ !github.event.release.prerelease || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Get release info
        id: release
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ inputs.tag }}"
          } else {
            $tag = "${{ github.event.release.tag_name }}"
          }
          $version = $tag -replace '^v', ''
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Release: $tag (v$version)"

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.release.outputs.tag }}

      - name: Download EXE installer
        id: download
        shell: pwsh
        run: |
          $version = "${{ steps.release.outputs.version }}"
          $url = "https://github.com/AmarBego/GitTop/releases/download/v$version/gittop-$version-windows-x86_64-setup.exe"
          Invoke-WebRequest -Uri $url -OutFile gittop-setup.exe

          $hash = (Get-FileHash gittop-setup.exe -Algorithm SHA256).Hash
          echo "checksum=$hash" >> $env:GITHUB_OUTPUT

      - name: Prepare Chocolatey package
        shell: pwsh
        run: |
          $version = "${{ steps.release.outputs.version }}"
          $checksum = "${{ steps.download.outputs.checksum }}"

          # Update nuspec
          $nuspec = Get-Content packaging/chocolatey/gittop.nuspec -Raw
          $nuspec = $nuspec -replace '\{\{VERSION\}\}', $version
          Set-Content packaging/chocolatey/gittop.nuspec $nuspec

          # Update install script
          $install = Get-Content packaging/chocolatey/tools/chocolateyInstall.ps1 -Raw
          $install = $install -replace '\{\{VERSION\}\}', $version
          $install = $install -replace '\{\{CHECKSUM\}\}', $checksum
          Set-Content packaging/chocolatey/tools/chocolateyInstall.ps1 $install

          Write-Host "Updated package for version $version with checksum $checksum"

      - name: Pack Chocolatey package
        shell: pwsh
        run: |
          cd packaging/chocolatey
          choco pack
          Get-ChildItem *.nupkg

      - name: Push to Chocolatey
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          cd packaging/chocolatey
          $nupkg = Get-ChildItem *.nupkg | Select-Object -First 1
          choco push $nupkg.Name --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY

      - uses: kesin11/actions-timeline@v2
