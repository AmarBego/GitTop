name: Prek Labeler

on:
  workflow_run:
    workflows: ["Prek"]
    types:
      - completed

jobs:
  label:
    name: Update Prek Labels
    # Run on both success and failure since we now always upload artifacts
    if: github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      issues: write
      pull-requests: write
    steps:
      - name: Download prek result
        uses: actions/download-artifact@v4
        with:
          name: prek-result
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update labels and comments
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");

            // Read the result artifact
            const resultPath = path.join(process.env.GITHUB_WORKSPACE, "prek-result.json");
            if (!fs.existsSync(resultPath)) {
              console.log("No prek-result.json found, skipping");
              return;
            }

            const result = JSON.parse(fs.readFileSync(resultPath, "utf8"));
            const pr_number = result.pr_number;
            const failed = result.failed;
            const failedSteps = result.failed_steps || [];

            if (!pr_number) {
              console.log("No PR number in result, skipping");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr_number;
            const labelName = "triage/prek-failed";
            const labelColor = "d73a4a";
            const labelDescription = "prek checks failed (fmt/clippy/test)";
            const commentMarker = "<!-- gittop:prek-failed -->";
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${{ github.event.workflow_run.id }}`;

            // Ensure label exists
            try {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: labelName,
                color: labelColor,
                description: labelDescription
              });
            } catch (error) {
              if (error.status === 422) {
                try {
                  await github.rest.issues.updateLabel({
                    owner,
                    repo,
                    name: labelName,
                    color: labelColor,
                    description: labelDescription
                  });
                } catch (e) {}
              }
            }

            // Get current labels
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pr_number
            });
            const currentLabels = pr.labels.map(l => l.name);
            const hasLabel = currentLabels.includes(labelName);

            // Add or remove label
            if (failed && !hasLabel) {
              console.log(`prek failed; adding label '${labelName}'.`);
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: [labelName]
              });
            } else if (!failed && hasLabel) {
              console.log(`prek passed; removing label '${labelName}'.`);
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number,
                  name: labelName
                });
              } catch (error) {
                if (error.status !== 404) throw error;
              }
            }

            // Manage comment
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100
            });
            const existingComment = comments.find(c => (c.body || "").includes(commentMarker));

            if (failed) {
              const failureLine = failedSteps.length
                ? `Failed hooks: ${failedSteps.join(", ")}.`
                : "prek checks failed.";
              const commentBody = [
                failureLine,
                `Logs: ${runUrl}`,
                "Fix the issue(s) and push to rerun checks.",
                commentMarker
              ].join("\n");

              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: existingComment.id,
                  body: commentBody
                });
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: commentBody
                });
              }
            } else if (existingComment) {
              try {
                await github.rest.issues.deleteComment({
                  owner,
                  repo,
                  comment_id: existingComment.id
                });
              } catch (error) {
                if (error.status !== 404) throw error;
              }
            }
